<!DOCTYPE html><html lang="zh-CN" class="loading"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><title>“工匠精神” 精心打造一个代理服务器 - JiangXin.info</title><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="google" content="notranslate"><meta name="description" content="组织结构是生产力。诚然。。。,前言首先，本文会涉及众多代理软件的名字，但因为本人是在国外，用代理软件是回国的，是一名爱国青年。所以请大家不要把代理的方向反转来用。在国外很多时候打开国内的网站非常缓慢，而且时不时有境外 IP 受限,"><meta name="author" content="Dazui"><link rel="alternative" href="atom.xml" title="JiangXin.info" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link href="https://fonts.loli.net/css?family=Roboto+Mono|Rubik&display=swap" rel="stylesheet"><link rel="stylesheet" href="//at.alicdn.com/t/font_1429596_nzgqgvnmkjb.css"><link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.7.2/animate.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/codemirror.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/theme/dracula.css"><link rel="stylesheet" href="/css/obsidian.css"><link rel="stylesheet" href="/css/ball-atom.min.css"><meta name="generator" content="Hexo 4.0.0"></head></html><body class="loading"><div class="loader"><div class="la-ball-atom la-2x"><div></div><div></div><div></div><div></div></div></div><span id="config-title" style="display:none">JiangXin.info</span><div id="loader"></div><div id="single"><div class="scrollbar gradient-bg-rev"></div><div id="top" style="display:block"><div class="bar" style="width:0"></div><div class="navigation animated fadeIn fast delay-1s"><img id="home-icon" class="icon-home" src="/img/favicon.png" alt="" data-url="http://jiangxin.info"><div id="play-icon" title="Play/Pause" class="iconfont icon-play"></div><h3 class="subtitle">“工匠精神” 精心打造一个代理服务器</h3><div class="social"><div><div class="share"><a href="javascript:;" target="_blank" rel="noopener" class="iconfont icon-share1"></a><div class="share-component-cc" data-disabled=""></div></div></div></div></div></div><div class="section"><div class="article-header-wrapper"><div class="article-header"><div class="article-cover animated fadeIn" style="animation-delay:.6s;animation-duration:1.2s;background-image:radial-gradient(ellipse closest-side,rgba(0,0,0,.65),#100e17),url(/img/cover.jpg)"></div><div class="else"><p class="animated fadeInDown"><a href="javascript:;" target="_blank" rel="noopener"><b>「 </b>文章<b> 」</b></a> 八月 07, 2018</p><h3 class="post-title animated fadeInDown"><a href="/0807/high-quality-proxy/" title="“工匠精神” 精心打造一个代理服务器">“工匠精神” 精心打造一个代理服务器</a></h3><p class="post-count animated fadeInDown"><span><b class="iconfont icon-text2"></b> <i>文章字数</i> 14k </span><span><b class="iconfont icon-timer__s"></b> <i>阅读约需</i> 12 mins. </span><span id="busuanzi_container_page_pv"><b class="iconfont icon-read"></b> <i>阅读次数</i> <span id="busuanzi_value_page_pv">0</span></span></p></div></div></div><div class="screen-gradient-after"><div class="screen-gradient-content"><div class="screen-gradient-content-inside"><div class="bold-underline-links screen-gradient-sponsor"><p><span class="animated fadeIn delay-1s"></span></p></div></div></div></div><div class="article"><div class="main"><div class="content markdown animated fadeIn"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>首先，本文会涉及众多代理软件的名字，但因为本人是在国外，用代理软件是回国的，是一名爱国青年。所以请大家不要把代理的方向反转来用。</p><p>在国外很多时候打开国内的网站非常缓慢，而且时不时有境外 IP 受限的问题。而代理软件的 obfs 或者 Websocks 能让我冒认成其他软件的服务器干些嘿嘿嘿的事情之外，还能帮助我突破一些的网络限制，比如我们学校的 Wi-Fi ，除了 443 和 80 端口，其他端口很多都是不通的。经过代理后就不会有域名和端口被限制的问题，还能保障安全，随便连各种 Wi-Fi 。</p><p>从而有了这篇文章，整个代理实现了：obfs + 服务器 IP 分流 + UDP 转发 + 去广告 + IPv6 支持 。</p><a id="more"></a><h1 id="代理入口"><a href="#代理入口" class="headerlink" title="代理入口"></a>代理入口</h1><h2 id="Shadowsocks"><a href="#Shadowsocks" class="headerlink" title="Shadowsocks"></a>Shadowsocks</h2><p>之所以选择 Shadowsocks 作为代理入口是因为 Shadowsocks 都发展有一段时间了，各平台的客户端也比较完善，用起来比较顺手。而目前 V2ray 的手机客户端目前还不稳定，如果直接用 V2ray 作为入口的话，就可以直接在 V2ray 实现 UDP 转发和 IP 分流，也能用 Caddy 和 Nginx 直接代理它的 Websocks 不需要再套 SNIPROXY，整个过程更加简洁。但截止目前 2017-11-15 ，IOS 端的 ShadowRay 还是很不稳定，丢失 VPN 图标经常发生，而且 IPv6 支持并不完美（不支持直接打开 IPv6 地址），也不支持 UDP 转发。综合以上的考虑，决定使用 Shadowsocks 作为代理的入口。</p><h3 id="配置-Shadowsocks"><a href="#配置-Shadowsocks" class="headerlink" title="配置 Shadowsocks"></a>配置 Shadowsocks</h3><p>相信大家对于这个已经不陌生了，我也不过多介绍。</p><blockquote><p>推荐使用 秋水逸冰 的一键安装脚本，Shadowsocks-libev 版<br><a href="https://teddysun.com/" target="_blank" rel="noopener">https://teddysun.com/</a></p></blockquote><h3 id="Shadowsocks-优化"><a href="#Shadowsocks-优化" class="headerlink" title="Shadowsocks 优化"></a>Shadowsocks 优化</h3><p>除了基本的安装，当然还要有一些其他的优化，比如打开 BBR 和 TCP Fast Open ，还有一些 sysctl 的优化，我直接放上来。</p><p>原本我是参考小数派里面一篇很好的文章的，里面有详细写到每一项的作用，但 “不知道为什么” ，这文章后来被删除了。</p><p>所以如果大家要了解以下 sysctl 设置的作用的话，可以 Google 一下。</p><pre><code class="stylus">net.ipv6.conf.all.accept_ra = 2
net.ipv4.tcp_fastopen = 3
net.ipv4.tcp_congestion_control = bbr
net.core.default_qdisc = fq
fs.file-max = 1024000
kernel.msgmnb = 65536
kernel.msgmax = 65536
kernel.shmmax = 68719476736
kernel.shmall = 4294967296
net.core.rmem_max = 12582912
net.core.wmem_max = 12582912
net.ipv4.tcp_rmem = 10240 87380 12582912
net.ipv4.tcp_wmem = 10240 87380 12582912
net.ipv4.ip_forward = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_mtu_probing = 1
net.ipv4.conf.all.accept_source_route = 1n
et.ipv4.conf.default.accept_source_route = 1
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.lo.send_redirects = 0
net.ipv4.conf.all.rp_filter = 0
net.ipv4.conf.default.rp_filter = 0
net.ipv4.conf.lo.rp_filter = 0
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv6.conf.all.accept_source_route = 1
net.ipv6.conf.default.accept_source_route = 1
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0
net.ipv6.conf.all.autoconf = 1
net.ipv6.conf.all.forwarding = 1</code></pre><h3 id="Shadowsocks-配置文件"><a href="#Shadowsocks-配置文件" class="headerlink" title="Shadowsocks 配置文件"></a>Shadowsocks 配置文件</h3><p>因为我们需要兼容到 WEB 服务器的运行，然后用 443 端口来做代理 TCP 和 UDP 的 Shadowsocks 流量。我们要分别跑两个 Shadowsocks 服务，一个是 TCP + obfs server 的，另一个是 UDP Only 的，因为 SNIPROXY 不代理 UDP 流量。</p><p>TCP SERVER:</p><pre><code class="json">{
    &quot;server&quot;:[&quot;[::1]&quot;,&quot;127.0.0.1&quot;],
    &quot;server_port&quot;:8988,
    &quot;local_address&quot;:&quot;127.0.0.1&quot;,
    &quot;local_port&quot;:1080,
    &quot;password&quot;:&quot;stevenkwan.me&quot;,
    &quot;timeout&quot;:600,
    &quot;method&quot;:&quot;chacha20-ietf-poly1305&quot;
}</code></pre><p>因为服务还需要经过 SNIPROXY 代理，所以监听 IPv4 的 <code>127.0.0.1</code> 即可，顺带提一下 IPv6 里是 <code>[::1]</code> 。</p><p>在运行的时候，还需要加上以下的参数：</p><p><code>-6 -c /xxxxxx/ss-tls.conf -d 127.0.0.1:53 --plugin obfs-server --plugin-opts &quot;obfs=tls;fast-open&quot;</code></p><p><code>-6</code> 优先使用 IPv6 地址。</p><p><code>-d</code> 指定 DNS 服务器，这里指定为本机的 dnsmasq 服务器，下面去广告会用到。</p><p>UDP Only SERVER:</p><pre><code class="json">{
    &quot;server&quot;:[&quot;[::0]&quot;,&quot;0.0.0.0&quot;],
    &quot;server_port&quot;:443,
    &quot;local_address&quot;:&quot;127.0.0.1&quot;,
    &quot;local_port&quot;:443,
    &quot;password&quot;:&quot;stevenkwan.me&quot;,
    &quot;timeout&quot;:600,
    &quot;method&quot;:&quot;chacha20-ietf-poly1305&quot;
}</code></pre><p>这里的 UDP 是需要直接暴露在公网的 443 端口。</p><p>在运行的时候，还需要加上以下的参数：</p><p><code>-6 -U -c /xxxx/udp-443.conf -d 127.0.0.1:53</code></p><p><code>-U</code> 大写的 U 代表只开启 UDP 转发不开启 TCP 转发，如果写成小写的话，是两个同时开始。有 WEB Server 的话就会提示端口已经被占用。</p><h1 id="兼容-WEB"><a href="#兼容-WEB" class="headerlink" title="兼容 WEB"></a>兼容 WEB</h1><h2 id="SNIPROXY"><a href="#SNIPROXY" class="headerlink" title="SNIPROXY"></a>SNIPROXY</h2><p>SNIPROXY 的设置非常简单，直接上配置文件。</p><p>需要注意的是，启用前，要先将 WEB Server 改成非 443 端口。</p><pre><code class="stylus">user daemon

pidfile /tmp/sniproxy.pid

error_log {
    syslog daemon
    priority notice
}

listen 443 {
    protocol tls
    reuseport no
    table https
    fallback [::1]:445
}

table https {
    www.google.com [::1]:8988
}</code></pre><p><code>fallback</code> 指向你的 WEB Server 端口即可。</p><p><code>table https</code> 里面写你 Shadowsoks 里使用的 obfs 域名。</p><h1 id="中转服务器"><a href="#中转服务器" class="headerlink" title="中转服务器"></a>中转服务器</h1><h2 id="V2ray"><a href="#V2ray" class="headerlink" title="V2ray"></a>V2ray</h2><p>除了我上面说的 V2ray 客户端不足，V2ray 还是有很多优势的，适合用来 “长距离” “翻山越岭” 。它支持 mkcp 和 mux 。</p><p>我曾经用过 Shadowsocks 作为中转服务器，那速度真的太慢了。</p><p>这里我用到了 mkcp 和 动态端口。</p><p>国内服务器配置文件：</p><pre><code class="json">{
  &quot;inbound&quot;: {
    &quot;port&quot;: 8888,
    &quot;protocol&quot;: &quot;vmess&quot;,
    &quot;streamSettings&quot;: {
      &quot;network&quot;: &quot;kcp&quot;
    },
    &quot;settings&quot;: {
      &quot;clients&quot;: [
        {
          &quot;id&quot;: &quot;xxxxxxxxxx&quot;,
          &quot;level&quot;: 1,
          &quot;alterId&quot;: 32
        }
      ],
      &quot;detour&quot;: {
        &quot;to&quot;: &quot;detour-kcp&quot;
      }
    }
  },
  &quot;inboundDetour&quot;: [
    {
      &quot;protocol&quot;: &quot;vmess&quot;,
      &quot;port&quot;: &quot;8889-9999&quot;,
      &quot;tag&quot;: &quot;detour-kcp&quot;,
      &quot;settings&quot;: {},
      &quot;allocate&quot;: {
        &quot;strategy&quot;: &quot;random&quot;,
        &quot;concurrency&quot;: 2,
        &quot;refresh&quot;: 5
      },
      &quot;streamSettings&quot;: {
        &quot;network&quot;: &quot;kcp&quot;
      }
    }
  ],
  &quot;outbound&quot;: {
    &quot;protocol&quot;: &quot;freedom&quot;,
    &quot;settings&quot;: {}
  },
  &quot;outboundDetour&quot;: [
    {
      &quot;protocol&quot;: &quot;blackhole&quot;,
      &quot;settings&quot;: {},
      &quot;tag&quot;: &quot;blocked&quot;
    }
  ],
  &quot;routing&quot;: {
    &quot;strategy&quot;: &quot;rules&quot;,
    &quot;settings&quot;: {
      &quot;rules&quot;: [
        {
          &quot;type&quot;: &quot;field&quot;,
          &quot;ip&quot;: [
            &quot;0.0.0.0/8&quot;,
            &quot;10.0.0.0/8&quot;,
            &quot;100.64.0.0/10&quot;,
            &quot;127.0.0.0/8&quot;,
            &quot;169.254.0.0/16&quot;,
            &quot;172.16.0.0/12&quot;,
            &quot;192.0.0.0/24&quot;,
            &quot;192.0.2.0/24&quot;,
            &quot;192.168.0.0/16&quot;,
            &quot;198.18.0.0/15&quot;,
            &quot;198.51.100.0/24&quot;,
            &quot;203.0.113.0/24&quot;,
            &quot;::1/128&quot;,
            &quot;fc00::/7&quot;,
            &quot;fe80::/10&quot;
          ],
          &quot;outboundTag&quot;: &quot;blocked&quot;
        }
      ]
    }
  },
  &quot;transport&quot;: {
    &quot;kcpSettings&quot;: {
      &quot;mtu&quot;: 1400,
      &quot;tti&quot;: 20,
      &quot;uplinkCapacity&quot;: 10,
      &quot;downlinkCapacity&quot;: 10,
      &quot;congestion&quot;: false,
      &quot;readBufferSize&quot;: 2,
      &quot;writeBufferSize&quot;: 2,
      &quot;header&quot;: {
        &quot;type&quot;: &quot;none&quot;
      }
    }
  }
}</code></pre><p>请自行修改配置文件的端口、动态端口范围、客户 ID 。</p><p>国外服务器配置文件：</p><pre><code class="json">{
  &quot;inbound&quot;: {
    &quot;protocol&quot;: &quot;dokodemo-door&quot;,
    &quot;port&quot;: 1080,
    &quot;settings&quot;: {
      &quot;network&quot;: &quot;tcp,udp&quot;,
      &quot;timeout&quot;: 30,
      &quot;followRedirect&quot;: true
    }
  },
  &quot;outbound&quot;: {
    &quot;protocol&quot;: &quot;vmess&quot;,
    &quot;streamSettings&quot;: {
      &quot;network&quot;: &quot;kcp&quot;
    },
    &quot;mux&quot;: {
      &quot;enabled&quot;: true,
      &quot;concurrency&quot;: 8
    },
    &quot;settings&quot;: {
      &quot;vnext&quot;: [
        {
          &quot;address&quot;: &quot;8.8.8.8&quot;,
          &quot;port&quot;: 8888,
          &quot;users&quot;: [
            {
              &quot;id&quot;: &quot;xxxxxxxxxx&quot;,
              &quot;alterId&quot;: 32,
              &quot;security&quot;: &quot;aes-128-gcm&quot;
            }
          ]
        }
      ]
    }
  },
  &quot;transport&quot;: {
    &quot;kcpSettings&quot;: {
      &quot;mtu&quot;: 1400,
      &quot;tti&quot;: 20,
      &quot;uplinkCapacity&quot;: 100,
      &quot;downlinkCapacity&quot;: 100,
      &quot;congestion&quot;: false,
      &quot;readBufferSize&quot;: 2,
      &quot;writeBufferSize&quot;: 2,
      &quot;header&quot;: {
        &quot;type&quot;: &quot;none&quot;
      }
    }
  }
}</code></pre><p>这里我们将 V2ray 的 inbound 设置为透明代理，这样 iptables 就能把国内流量转发到 V2ray 上。</p><blockquote><p>更详细的设置 V2ray 设置可以参考他们家的官网 <a href="https://www.v2ray.com/" target="_blank" rel="noopener">https://www.v2ray.com</a></p></blockquote><h1 id="IP-分流"><a href="#IP-分流" class="headerlink" title="IP 分流"></a>IP 分流</h1><h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h2><p>要根据 IP 来分流，除了 iptables 之外，也没其他什么软件能做到了。但是单纯靠 iptables 来分流的话，会造成性能低下，这时候我们需要 ipset 。</p><p>下面这篇文章测试了在使用 ipset 和不使用 ipset 时 iptables 的性能。</p><blockquote><p><a href="http://blog.csdn.net/dog250/article/details/41171643" target="_blank" rel="noopener">http://blog.csdn.net/dog250/article/details/41171643</a></p></blockquote><h3 id="ipset"><a href="#ipset" class="headerlink" title="ipset"></a>ipset</h3><p>在这里推荐大家用这个项目来获取中国的 IP 地址，每月更新的。</p><blockquote><p><a href="https://github.com/17mon/china_ip_list" target="_blank" rel="noopener">https://github.com/17mon/china_ip_list</a></p></blockquote><p>这里我只转发了 TCP 流量：</p><pre><code>ipset -N chnroute hash:net maxelem 65536
ipset add chnroute $IP
iptables -t nat -N V2RAY
iptables -t nat -A V2RAY -p tcp -m set --match-set chnroute dst -j REDIRECT --to-port 1080
iptables -t nat -A OUTPUT -p tcp -j V2RAY</code></pre><p>将上面的 <code>$IP</code> 换成你需要添加的 IP 地址，推荐大家用脚本来添加，这样可以设置成每月任务，自动更新。</p><p>更新前，通常需要先移除旧规则：</p><pre><code>iptables -t nat -D OUTPUT -p tcp -j V2RAY
iptables -t nat -F V2RAY
iptables -t nat -X V2RAY
ipset destroy chnroute</code></pre><h1 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h1><p>在上面配置 Shadowsocks 服务端的时候，我们已经做好了完整的 UDP 转发支持。但客户端支不支持，却又是另一回事，我们可以通过以下方法来测试。</p><h2 id="测试-UDP"><a href="#测试-UDP" class="headerlink" title="测试 UDP"></a>测试 UDP</h2><p>我们在服务器上打开一个 screen 运行 <code>nc -lu 20000</code> 来监听 20000 端口的 UDP 。</p><p>然后在需要测试的设备上，发一个 UDP 包到你的服务器上。</p><p>如果服务器能收到这个 UDP 包，那么就可以再新开一个 screen 运行 <code>netstat -nu | grep 20000</code> 来查看来源 IP ，通过来源 IP 来判断是否走了代理。</p><p>截止 2017-11-15 ，IOS 客户端就只有 Shadowrocket 支持 UDP 转发，Surge 和 ShadowRay 均为直连。</p><h1 id="IPv6-支持"><a href="#IPv6-支持" class="headerlink" title="IPv6 支持"></a>IPv6 支持</h1><p>在上面配置 Shadowsocks 服务端的时候，已经做好了完整的 IPv6 支持，大家可以打开一下网站里面的 “技术信息” 来测试 IPv6 。</p><blockquote><p><a href="http://test-ipv6.com/" target="_blank" rel="noopener">http://test-ipv6.com</a></p></blockquote><p>截止 2017-11-15 ，IOS 客户端就只有 Surge 支持直接打开 IPv6 地址，Shadowrocket 和 ShadowRay 均失败。</p><h1 id="去广告-amp-境外受限"><a href="#去广告-amp-境外受限" class="headerlink" title="去广告 &amp; 境外受限"></a>去广告 &amp; 境外受限</h1><p>自建 DNS 服务器除了能达到去广告的目的外，还能解决部分国内服务商将域名在国外解析成 <code>127.0.0.1</code> 的问题（如网易云音乐）。</p><p>关于如何更好的解除境外受限，大家可以参考一下以下项目。</p><blockquote><p><a href="https://github.com/uku/Unblock-Youku" target="_blank" rel="noopener">https://github.com/uku/Unblock-Youku</a></p></blockquote><p>DNS 去广告的效果也是非常好的，因为是从根源上返回一个 fake IP ，无论是 HTTP 和 HTTPS 都支持。</p><p>但域名列表是需要经常更新的，大家可以写个脚本来定期更新。</p><p>这里推荐一下这个更新广告域名的项目：</p><blockquote><p><a href="https://github.com/StevenBlack/hosts" target="_blank" rel="noopener">https://github.com/StevenBlack/hosts</a></p></blockquote><p>还有个小问题是，大多数的去广告 hosts 文件都是把 IP 指向了 <code>127.0.0.1</code> 或者 <code>0.0.0.0</code> ，但我服务器上是有 WEB Server 的，这会造成浏览器在尝试连接时，会等待结果而不是立即断开连接。我也试过把 IP 地址改成美国国防部的保留 IP 地址，然后通过 iptables 把所有出去的包 drop 了，效果也是不理想。推荐大家把 IP 指向 <code>224.0.0.0</code> 等特殊 IP 地址，实测不会拖慢网页加载速度。（以上结论暂时还没有进行过详细的测试，仅凭实测，如有错误，欢迎指出）</p><h2 id="dnsmasq-配置"><a href="#dnsmasq-配置" class="headerlink" title="dnsmasq 配置"></a>dnsmasq 配置</h2><pre><code>port=53
no-resolv
server=2001:4860:4860::8888
server=8.8.8.8
server=2620:0:ccc::2
server=208.67.222.222
all-servers
listen-address=127.0.0.1,::1
addn-hosts=/etc/dnsmasq_host/hosts</code></pre><p>这里我设置了 4 个 DNS 上有地址，是 Google Public DNS 和 OpenDNS 的 IPv4 和 IPv6 地址，用了 <code>all-servers</code> 选项去并发查询这 4 个服务器，取最先返回结果的。</p><p>如果 Shadowsocks 开启了 IPv6 优先的话，hosts 文件也要加入 IPv6 的地址，推荐使用 ‘FF00::’ 。</p><p>因为 DNS 服务器只是给本机使用的，安全起见可以只监听 <code>127.0.0.1</code> 。</p><p><code>addn-hosts</code> 则为去广告所用的 hosts 文件。</p><h1 id="大功告成～！"><a href="#大功告成～！" class="headerlink" title="大功告成～！"></a>大功告成～！</h1><p>至此为此，安全性和各种功能都有了，可以无拘无束的安心上网了。</p><p>原文链接：<a href="https://stevenkwan.me/post/perfect-proxy-server.html" target="_blank" rel="noopener">https://stevenkwan.me/post/perfect-proxy-server.html</a></p><p>– EOF –</p><!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]--><audio id="audio" loop preload="auto" controls data-autoplay="false"><source type="audio/mpeg" src=""></audio><ul id="audio-list" style="display:none"><li title="0" data-url="/statics/2523186479576881670_ud.mp3"></li></ul><div id="gitalk-container" class="comment link" data-ae="true" data-ci="a7243ad904aaa5951a38" data-cs="e3bc83e6f00badb4e6c66e3d0709fccb9e7b07e4" data-r="blog-comments" data-o="billy21" data-a="billy21" data-d="">留言</div></div><div class="sidebar"><div class="box animated fadeInRight"><div class="subbox"><img src="/img/avatar.jpg" height="300" width="300"><p>Dazui</p><span></span><dl><dd><a href="https://github.com/billy21" target="_blank"><span class="iconfont icon-github"></span></a></dd><dd><a href="https://twitter.com/Incubus" target="_blank"><span class="iconfont icon-twitter"></span></a></dd><dd><a href="https://weibo.com/jiangxin128" target="_blank"><span class="iconfont icon-weibo"></span></a></dd></dl></div><ul><li><a href="/">44<p>文章</p></a></li><li><a href="/categories">7<p>分类</p></a></li><li><a href="/tags">140<p>标签</p></a></li></ul></div><div class="box sticky animated fadeInRight faster"><div id="toc" class="subbox"><h4>目录</h4><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#代理入口"><span class="toc-number">2.</span> <span class="toc-text">代理入口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Shadowsocks"><span class="toc-number">2.1.</span> <span class="toc-text">Shadowsocks</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-Shadowsocks"><span class="toc-number">2.1.1.</span> <span class="toc-text">配置 Shadowsocks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shadowsocks-优化"><span class="toc-number">2.1.2.</span> <span class="toc-text">Shadowsocks 优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shadowsocks-配置文件"><span class="toc-number">2.1.3.</span> <span class="toc-text">Shadowsocks 配置文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#兼容-WEB"><span class="toc-number">3.</span> <span class="toc-text">兼容 WEB</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SNIPROXY"><span class="toc-number">3.1.</span> <span class="toc-text">SNIPROXY</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#中转服务器"><span class="toc-number">4.</span> <span class="toc-text">中转服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#V2ray"><span class="toc-number">4.1.</span> <span class="toc-text">V2ray</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IP-分流"><span class="toc-number">5.</span> <span class="toc-text">IP 分流</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#iptables"><span class="toc-number">5.1.</span> <span class="toc-text">iptables</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ipset"><span class="toc-number">5.1.1.</span> <span class="toc-text">ipset</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#UDP"><span class="toc-number">6.</span> <span class="toc-text">UDP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#测试-UDP"><span class="toc-number">6.1.</span> <span class="toc-text">测试 UDP</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IPv6-支持"><span class="toc-number">7.</span> <span class="toc-text">IPv6 支持</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#去广告-amp-境外受限"><span class="toc-number">8.</span> <span class="toc-text">去广告 &amp; 境外受限</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dnsmasq-配置"><span class="toc-number">8.1.</span> <span class="toc-text">dnsmasq 配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#大功告成～！"><span class="toc-number">9.</span> <span class="toc-text">大功告成～！</span></a></li></ol></div></div></div></div></div></div></div><div id="back-to-top" class="animated fadeIn faster"><div class="flow"></div><span class="percentage animated fadeIn faster">0%</span> <span class="iconfont icon-top02 animated fadeIn faster"></span></div></body><footer><p class="copyright" id="copyright">&copy; 2019 <span class="gradient-text">Dazui </span>. Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> Theme <span class="gradient-text"><a href="https://github.com/TriDiamond/hexo-theme-obsidian" title="Obsidian" target="_blank" rel="noopener">Obsidian</a> </span><small><a href="https://github.com/TriDiamond/hexo-theme-obsidian/blob/master/CHANGELOG.md" title="v1.4.3" target="_blank" rel="noopener">v1.4.3</a></small></p></footer><script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>MathJax.Hub.Config({"HTML-CSS":{preferredFont:"TeX",availableFonts:["STIX","TeX"],linebreaks:{automatic:!0},EqnChunk:MathJax.Hub.Browser.isMobile?10:50},tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],processEscapes:!0,ignoreClass:"tex2jax_ignore|dno",skipTags:["script","noscript","style","textarea","pre","code"]},TeX:{noUndefined:{attributes:{mathcolor:"red",mathbackground:"#FFEEEE",mathsize:"90%"}},Macros:{href:"{}"}},messageStyle:"none"})</script><script>function initialMathJax(){MathJax.Hub.Queue(function(){var e,a=MathJax.Hub.getAllJax();for(e=0;e<a.length;e+=1)console.log(a[e].SourceElement().parentNode),a[e].SourceElement().parentNode.className+=" has-jax"})}function reprocessMathJax(){"undefined"!=typeof MathJax&&MathJax.Hub.Queue(["Typeset",MathJax.Hub])}</script><link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.css"><script src="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script><script src="/js/plugin.js"></script><script src="/js/obsidian.js"></script><script src="/js/jquery.truncate.js"></script><script src="/js/search.js"></script><script src="//cdn.bootcss.com/typed.js/2.0.10/typed.min.js"></script><script src="//cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script><script src="https://cdn.bootcss.com/codemirror/5.48.4/codemirror.min.js"></script><script src="//cdn.bootcss.com/codemirror/5.48.4/mode/javascript/javascript.min.js"></script><script src="//cdn.bootcss.com/codemirror/5.48.4/mode/css/css.min.js"></script><script src="//cdn.bootcss.com/codemirror/5.48.4/mode/xml/xml.min.js"></script><script src="//cdn.bootcss.com/codemirror/5.48.4/mode/htmlmixed/htmlmixed.min.js"></script><script src="//cdn.bootcss.com/codemirror/5.48.4/mode/clike/clike.min.js"></script><script src="//cdn.bootcss.com/codemirror/5.48.4/mode/php/php.min.js"></script><script src="//cdn.bootcss.com/codemirror/5.48.4/mode/shell/shell.min.js"></script><script src="//cdn.bootcss.com/codemirror/5.48.4/mode/python/python.min.js"></script><script src="//cdn.bootcss.com/codemirror/5.48.4/mode/bash/bash.min.js"></script><script src="/js/busuanzi.min.js"></script><script>$(document).ready(function(){$('span[id^="busuanzi_"]').length&&initialBusuanzi()})</script><link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/default-skin/default-skin.min.css"><script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.js"></script><script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button> <button class="pswp__button pswp__button--share" title="Share"></button> <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button> <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button> <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><script async src="//www.googletagmanager.com/gtag/js?id=UA-68770355-2"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-68770355-2")</script><script>function initialTyped(){var e=$(".typed-text");e&&0<e.length&&new Typed(".typed-text",{strings:["","不乱于心，不困于情。不畏将来，不念过往。如此，安好。"],typeSpeed:90,loop:!0,loopCount:1/0,backSpeed:20})}$(".article-header")&&$(".article-header").length&&$(document).ready(function(){initialTyped()})</script>